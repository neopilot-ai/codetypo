# GitHub Action to check our dictionary, this should only be used by the codetypo project itself
# For general usage in your repo, see the example in codetypo.yml
# https://github.com/khulnasoft/codetypo
# Concurrency cancels an action on a given PR once a new commit is pushed
name: Test Suite
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}-${{ github.event_ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main, master]
    tags: ["*"]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

# Set default permissions for all jobs
permissions:
  contents: read
  security-events: write # For security scanning
  actions: read # For code scanning
jobs:
  test:
    env:
      REQUIRE_ASPELL: ${{ startsWith(matrix.os, 'ubuntu') }}
      RUFF_OUTPUT_FORMAT: github
      COVERAGE_MIN: 90 # Minimum coverage percentage
    # Make sure we're using the latest aspell dictionary
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        kind:
          - "standard"
        os:
          - "ubuntu-24.04-arm"
        include:
          - python-version: "3.10"
            kind: "no-toml"
            os: "ubuntu-24.04-arm"
          - python-version: "3.13"
            kind: "standard"
            os: "windows-latest"
    name: "${{ matrix.python-version }} ${{ matrix.kind }} ${{ matrix.os }}"
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Setup python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
      - run: sudo apt-get install libaspell-dev aspell-en
        if: startsWith(matrix.os, 'ubuntu')
      - name: Install dependencies
        shell: bash -e {0}
        run: |
          python --version  # just to check
          pip install --upgrade pip wheel # upgrade to latest pip find 3.5 wheels; wheel to avoid errors
          pip install --upgrade "setuptools!=47.2.0" docutils setuptools_scm[toml] twine
          pip install -e ".[dev]" # install the codetypo dev packages
      - run: pip install aspell-python-py3
        if: startsWith(matrix.os, 'ubuntu')
      - run: codetypo --help
      - run: codetypo --version
      - run: make check
        if: startsWith(matrix.os, 'ubuntu')
      - run: pytest codetypo
        if: startsWith(matrix.os, 'windows')
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          verbose: true
          files: ./coverage.xml
          flags: unittests
          name: ${{ matrix.os }}-${{ matrix.python-version }}

      - name: Check coverage
        run: |
          coverage report --fail-under=$COVERAGE_MIN
          coverage xml

      # tomli should not be required for the next two steps (and make sure it's not)
      - run: pip uninstall -yq tomli
        if: ${{ matrix.kind == 'no-toml' }}
      - run: codetypo --check-filenames --skip="./.*,./build/*,./codetypo/data/*,./codetypo/tests/test_basic.py,./example/code.c,./junit-results.xml,*.egg-info/*,*.pyc,*.sig,pyproject-codetypo.precommit-toml,README.rst,"
      # this file has an error
      - run: "! codetypo codetypo/tests/test_basic.py"
        shell: bash -e {0}

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff
        run: make ruff

      - name: Run Mypy
        run: make mypy

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit security scanner
        uses: PyCQA/bandit@main
        with:
          args: -r codetypo/ -n 5 --skip B101

      - name: Run Safety check
        run: |
          pip install safety
          safety check --full-report

  make-check-dictionaries:
    needs: [test, lint, security-scan]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Install general dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -e ".[dev]"
          pip install pre-commit
          pre-commit install-hooks

      - name: Check dictionary formatting
        run: make check-dictionaries

      - name: Run pre-commit on all files
        run: pre-commit run --all-files
